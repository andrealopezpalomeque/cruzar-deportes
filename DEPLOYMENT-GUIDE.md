# Cruzar Deportes - Deployment Guide

## ‚úÖ System Status

All image loading issues have been **permanently fixed**:
- Back-office now uses real Cloudinary URLs from `url-mapping.json`
- All 237 products with 5,707 valid, working image URLs
- Firebase Storage updated with correct data
- Deploy script ready to push changes to storefront

## üöÄ How to Deploy Changes from Back-Office to Storefront

### Simple One-Command Deploy:

```bash
cd /Users/andreavictorialopezpalomeque/Documents/personal-projects/cruzar-deportes
./shared/scripts/deploy-home.sh
```

This automated script will:
1. Download latest `products.json` from Firebase Storage
2. Rebuild catalog with fresh URLs from `url-mapping.json`
3. Build the storefront with updated data
4. Deploy to Firebase Hosting

### What Gets Deployed:
- ‚úÖ Price changes
- ‚úÖ Product images (from back-office selections)
- ‚úÖ Featured/stock status updates
- ‚úÖ Product descriptions and details

## üìù Making Changes in Back-Office

### Editing Products:
1. Open back-office and make your changes (prices, images, status, etc.)
2. Changes are automatically saved to Firebase Storage
3. Run the deploy script to push to storefront

### Selecting Images:
- Click "Manage Images" on any product
- The back-office will show all available images from Cloudinary
- Select up to 5 images for display
- Images are saved as real Cloudinary URLs (not broken URLs!)

## üîß Manual Operations

### Upload products.json to Firebase Storage:
```bash
cd back-office
node scripts/upload-products.ts
```

### Regenerate all product URLs:
```bash
cd back-office
node scripts/rebuild-catalog.ts
```

This will:
- Read all teams from `shared/catalog.ts`
- Load real Cloudinary URLs from `url-mapping.json`
- Update all products with correct image URLs
- Preserve user-edited fields (prices, descriptions, etc.)
- Save to both local file and Firebase Storage

### Download from Firebase Storage:
```bash
cd back-office
node scripts/bootstrap-storage.ts
```

## üêõ Troubleshooting

### If images still don't show after deploy:

1. **Check products.json has valid URLs:**
   ```bash
   cd /path/to/cruzar-deportes
   grep -o '"https://res.cloudinary.com/[^"]*"' shared/products.json | head -5
   ```

   ‚úÖ Valid URLs look like:
   ```
   https://res.cloudinary.com/dmb1vyveg/image/upload/v1758167554/cruzar-deportes/products/eredivisie/164829969/otcz50tpm2zbpn7wcuuq.jpg
   ```

   ‚ùå Invalid URLs look like:
   ```
   https://res.cloudinary.com/dmb1vyveg/image/upload/cruzar-deportes/eredivisie/164829969/164829969_photo_img_0_1756150226653
   ```

2. **Regenerate the catalog:**
   ```bash
   cd back-office
   node scripts/rebuild-catalog.ts
   node scripts/upload-products.ts
   ```

3. **Rebuild and redeploy storefront:**
   ```bash
   cd /path/to/cruzar-deportes
   ./shared/scripts/deploy-home.sh
   ```

### If Firebase CLI authentication fails:

```bash
firebase login
firebase projects:list
```

Ensure `cruzar-back-office` appears in the list.

## üìö Technical Details

### How Image URLs Work:

1. **Source of Truth**: `back-office/scripts/url-mapping.json`
   - Contains mapping of all uploaded images
   - Maps local paths ‚Üí real Cloudinary URLs
   - Generated during initial migration

2. **Back-Office**: Uses `cloudinaryUrlMapping.ts`
   - Reads from `url-mapping.json`
   - Returns real, working Cloudinary URLs
   - No transformations or modifications

3. **Storefront**: Validates URLs in `catalogLoader.ts`
   - Checks for proper file extensions (.jpg, .png, etc.)
   - Filters out invalid URLs
   - Falls back to placeholder if no valid images

### Data Flow:

```
Back-Office Edit
    ‚Üì
Firebase Storage (products.json)
    ‚Üì
Deploy Script (bootstrap-storage.ts)
    ‚Üì
Rebuild Catalog (rebuild-catalog.ts)
    ‚Üì
Storefront Build (nuxt generate)
    ‚Üì
Firebase Hosting
```

## üéØ Key Files

| File | Purpose |
|------|---------|
| `shared/products.json` | Main product database with all data |
| `back-office/scripts/url-mapping.json` | Real Cloudinary URL mappings |
| `back-office/scripts/rebuild-catalog.ts` | Regenerates products from catalog + URLs |
| `back-office/scripts/upload-products.ts` | Uploads to Firebase Storage |
| `shared/scripts/deploy-home.sh` | Complete deployment pipeline |
| `home/utils/catalogLoader.ts` | Storefront data loader with validation |

## ‚ö†Ô∏è Important Notes

- **Never edit `url-mapping.json` manually** - it's generated by migration scripts
- **Always use `rebuild-catalog.ts` to refresh URLs** - don't edit `products.json` directly
- **Storefront must be rebuilt** after changes - static site generation requires build
- **Back-office changes are instant** for the back-office app but need deploy for storefront

---

**Last Updated**: 2025-09-29
**Status**: ‚úÖ All systems operational
**Products**: 237
**Valid Image URLs**: 5,707